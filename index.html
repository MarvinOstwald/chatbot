<!DOCTYPE html>
<html lang="de">
  <head>
    <style>
      .gradient-text {
        font-size: 25px;
        background-image: linear-gradient(to right, rgb(182, 22, 22), red);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
      }

      .gradient-user {
        font-size: 30px;
        background-image: linear-gradient(
          to right,
          rgb(15, 163, 15),
          rgb(207, 128, 25)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
      }
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <div class="topbar">
      <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <i class="bi bi-lightning-charge"></i>
            <ul class="nav nav-underline">
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  href="#"
                  style="margin-left: 10px"
                  >Main
                </a>
              </li>
            </ul>

            <ul class="nav nav-underline" style="margin-left: 10px">
              <li class="nav-item">
                <a
                  class="nav-link"
                  aria-current="page"
                  href="info.html"
                  style="color: black"
                  >Infos</a
                >
              </li>
            </ul>

            <ul class="nav nav-underline" style="margin-left: 10px">
              <li class="nav-item">
                <a
                  class="nav-link"
                  aria-current="page"
                  href="befehle.html"
                  style="color: black"
                  >Befehle</a
                >
              </li>
            </ul>
          </div>
          <div class="container" style="text-align: center; margin-right: 95px">
            <a href="index.html" style="text-decoration: none">
              <b class="gradient-text"
                >Chatty Chatbot <i class="bi bi-robot"></i
              ></b>
            </a>
          </div>
          <div style="align-content: right">
            <button
              type="button"
              class="btn btn-outline-dark"
              style="background-color: greenyellow"
              id="login-button"
            >
              Login
            </button>
            <button
              type="button"
              class="btn btn-outline-dark"
              style="background-color: red; background: url()"
              id="logout-button"
              hidden
            >
              Logout
            </button>
          </div>
        </div>
      </nav>
    </div>
    <hr style="position: relative; top: -18px" />

    <div class="container;" style="margin-top: 25px; margin-left: 180px">
      <b style="font-size: 30px">Willkommen! </b>
      <b style="font-size: 30px" id="login-text"
        ><br />
        Logge dich ein um zu Starten :D</b
      >
      <b class="gradient-user" id="user-tag"></b>

      <div class="form-check" style="margin-top: 10px; margin-left: -25px">
        <button id="start-bot" class="btn btn-outline-dark" hidden>
          Starte Chatty
        </button>
      </div>
      <div
        class="card border-dark mb-3"
        style="width: 40rem; height: 35rem; margin-top: 15px"
        id="chat-box"
        hidden
      >
        <div class="card-body" style="overflow-y: auto">
          <h5 class="card-title" id="chat-titel"></h5>
          <div
            id="scroll-box"
            data-bs-spy="scroll"
            data-bs-smooth-scroll="true"
            class="scrollspy-example bg-body-tertiary p-3 rounded-5"
            tabindex="0"
            data-bs-root-margin="10px 10px -40%"
          >
            <p class="card-text" id="text-box-messages"></p>
          </div>
        </div>

        <form id="text-send-btn">
          <div class="input-group mb-0">
            <input
              type="text"
              class="form-control"
              id="send-box"
              placeholder="Sende eine Nachricht..."
            />
            <button class="btn btn-outline-dark" type="submit">Senden</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const CLIENT_ID = "c2g39epdg9tf9y24zlbz8lzn484fc7";
      let token;
      let userId;
      let data;
      let interval5;
      const loginButton = document.getElementById("login-button");
      const logoutButton = document.getElementById("logout-button");
      const startChatbot = document.getElementById("start-bot");
      const chatBox = document.getElementById("chat-box");
      const loginText = document.getElementById("login-text");
      const textBoxMessages = document.getElementById("text-box-messages");
      const chatTiel = document.getElementById("chat-titel");
      const sendBox = document.getElementById("send-box");
      const textSendForm = document.getElementById("text-send-btn");
      const scrollBox = document.getElementById("scroll-box");
      textSendForm.onsubmit = sendText;
      loginButton.onclick = login;
      logoutButton.onclick = logout;
      startChatbot.onclick = startBot;
      checkLogin();
      function login() {
        const url = new URL("https://id.twitch.tv/oauth2/authorize");
        url.searchParams.set("client_id", CLIENT_ID);
        url.searchParams.set("force_verify", true);
        url.searchParams.set("redirect_uri", "http://localhost:8080/");
        url.searchParams.set("response_type", "token");
        url.searchParams.set("scope", "user:write:chat user:read:chat");
        console.log(url.toString());
        window.location = url.toString();
      }

      async function checkLogin() {
        console.log(document.location.hash);
        if (document.location.hash) {
          const hash = document.location.hash.substring(1);
          const params = new URLSearchParams(hash);
          token = params.get("access_token");
          const response = await fetch("https://id.twitch.tv/oauth2/validate", {
            headers: { Authorization: `OAuth ${token}` },
          });
          if (response.ok) {
            const data = await response.json();
            userId = data.user_id;
            console.log(data.login);
            const userTag = document.getElementById("user-tag");
            userTag.innerText = data.login;
            chatTiel.innerHTML = `Chat von ${data.login}`;
            loginButton.hidden = true;
            logoutButton.hidden = false;
            startChatbot.hidden = false;
            //chatBox.hidden = false;
            loginText.hidden = true;
          }
        }
      }
      function logout() {
        window.location = "/";
      }
      async function startBot() {
        await removeDisconnectedWebsocketSubscriptions();
        const websocketClient = new WebSocket(
          "wss://eventsub.wss.twitch.tv/ws"
        );
        websocketClient.onmessage = processWebsocketMessage;
      }
      function processWebsocketMessage(message) {
        data = JSON.parse(message.data);
        console.log(data);

        function fiveMinuteMessage() {
          const messageFiveMinutes =
            "Diese Nachricht hier wird alle 5 Minuten automaisch in den Chat geschickt!";
          sendMessage(messageFiveMinutes);
        }
        if (data.metadata.message_type === "notification") {
          const notificationElement = document.createElement("p");
          const message = data.payload.event.message.text;
          const userName = data.payload.event.chatter_user_name;
          const heute = new Date();
          const isBroadcaster = data.payload.event.badges.some(
            (badge) => badge.set_id === "broadcaster"
          );
          const timeMessage = `${heute.getHours()}:${heute
            .getMinutes()
            .toString()
            .padStart(2, "0")}`;
          notificationElement.innerText = `${timeMessage} ${userName} | ${message}`;
          textBoxMessages.insertBefore(
            notificationElement,
            textBoxMessages.firstChild
          );

          if (message === "!start5") {
            if (isBroadcaster) {
              interval5 = setInterval(fiveMinuteMessage, 300000);
            }
          }
          if (message === "!stop5") {
            if (isBroadcaster) {
              clearInterval(interval5);
            }
          }

          if (message === "!hallo") {
            sendMessage(`Willkommen ${userName}`);
          }

          if (message === "!zahl") {
            const zahl = Math.floor(Math.random() * 11);
            sendMessage(`${userName} deine Zahl ist: ${zahl}`);
          }

          if (message === "!zeit") {
            const time = `${heute.getDate()}.${
              heute.getMonth() + 1
            }.${heute.getFullYear()} und ${timeMessage} Uhr`;
            sendMessage(`Es ist der ${time}`);
          }

          if (message === "!werbung") {
            const werbung = `Meine Sozial-Medias:
                      YouTube = youtube.com
                      Instagram = instagram.com
                      X = x.com`;
            sendMessage(werbung);
          }

          if (isBroadcaster) {
            if (message === "!nuke") {
              const nukeMessage = "NUKED! NUKED! NUKED! NUKED! NUKED!";
              for (let i = 0; i < 100; i++) {
                sendMessage(nukeMessage);
              }
            }
          }
          if (message === "!help") {
            sendMessage("Die offizielle Website:  ");
          }

          if (message.startsWith("!hug")) {
            const parts = message.split(" ");
            const targetUser = parts[1];
            if (targetUser) {
              sendMessage(
                `${targetUser} bekommt eine Umarmung von ${userName}`
              );
            }
          }

          if (message === "!8ball") {
            let answers = [
              "Auf jeden fall!",
              "Niemals!",
              "Nein",
              "Frag mich später",
              "Ja",
              "Komm später wieder!",
              "Natürlich!",
            ];
            let randomAnswer =
              answers[Math.floor(Math.random() * answers.length)];
            sendMessage(`${userName} ${randomAnswer}`);
          }

          if (message === "!fakt") {
            let facts = [
              "Koalas haben Fingerabdrücke, die fast identisch zu menschlichen sind.",
              "Die Erde ist keine perfekte Kugel, sondern an den Polen abgeflacht.",
              "Männliche Pinguine schenken Kieselsteine als Liebesbeweis.",
              "Das menschliche Gehirn wiegt etwa 1,4 Kilogramm.",
              "Honig kann praktisch nie schlecht werden – er ist antibakteriell.",
              "Bananen sind botanisch gesehen Beeren.",
              "Erdbeeren sind keine echten Beeren.",
              "Ein Oktopus hat drei Herzen.",
              "Katzen träumen im Schlaf, genau wie Menschen.",
              "Ein Blitz kann heißer als die Oberfläche der Sonne sein.",
              "Ameisen kommunizieren mit Duftstoffen – sogenannte Pheromone.",
              "Haie können elektrische Felder wahrnehmen.",
              "Neugeborene haben mehr Knochen als Erwachsene.",
              "Eine Wolke kann mehrere hundert Tonnen wiegen.",
              "Wombats machen würfelförmigen Kot.",
              "Goldfische können sich über Monate hinweg Dinge merken.",
              "Der kleinste Vogel der Welt ist die Bienenelfe.",
              "Die menschliche Zunge ist der stärkste Muskel gemessen an ihrer Größe.",
              "Regenwürmer haben fünf Herzbereiche, sogenannte Aortenbogen.",
              "Chamäleon-Augen können sich unabhängig voneinander bewegen.",
              "Das Herz eines Blauwals wiegt etwa eine Tonne.",
              "Gähnen ist auch unter Tieren ansteckend.",
              "Papier kann bis zu sieben Mal recycelt werden.",
              "Der größte Organismus der Welt ist ein unterirdischer Pilz.",
              "Kängurus können nicht rückwärts springen.",
              "Es gibt mehr Sterne im Universum als Sandkörner auf der Erde.",
              "Der menschliche Körper besteht aus etwa 37 Billionen Zellen.",
              "Die Haut erneuert sich etwa alle 27 Tage komplett.",
              "Spinnen können durch den Wind fliegen – sogenanntes „Ballooning“.",
              "Lachgas wurde früher als Narkosemittel eingesetzt.",
              "Alpakas spucken zur Kommunikation oder bei Ärger.",
              "Der tiefste Punkt im Ozean ist tiefer als der Mount Everest hoch ist.",
              "Der Saturn-Tag dauert nur rund 10,7 Stunden.",
              "Koalas schlafen bis zu 20 Stunden am Tag.",
              "Der längste je geflogene Hühnersprung war über 13 Sekunden.",
              "Kaffee ist die zweitmeist gehandelte Ware weltweit nach Öl.",
              "Die erste E-Mail wurde 1971 verschickt.",
              "Die menschliche Nase kann mehr als eine Billion Gerüche unterscheiden.",
              "Raben zählen zu den intelligentesten Vögeln der Welt.",
              "Die älteste bekannte Sprache ist Sumerisch.",
              "Erdnüsse sind keine Nüsse, sondern Hülsenfrüchte.",
              "Die Farbe Blau war früher so wertvoll wie Gold.",
              "Der Vollmond beeinflusst das Schlafverhalten mancher Menschen.",
              "Das längste Tennis-Match dauerte 11 Stunden und 5 Minuten.",
              "Die Pizza wurde vermutlich im antiken Griechenland erfunden.",
              "Wasser kann unter bestimmten Bedingungen gleichzeitig kochen und gefrieren.",
              "Kühe haben oft beste Freunde und leiden unter Trennung.",
              "Pflanzen reagieren auf Berührung und Musik.",
              "Ein Elefant kann die Stimme eines Menschen erkennen.",
              "Die erste Webcam zeigte eine Kaffeemaschine in Cambridge.",
              "Der menschliche Körper produziert täglich etwa 1 Liter Speichel.",
            ];
            let randomFact = facts[Math.floor(Math.random() * facts.length)];
            sendMessage(`${userName} hier dein Fakt: "${randomFact}"`);
          }

          if (message.startsWith("!roll")) {
            const parts = message.split(" ");
            const targetNumber = parts[1];
            console.log(targetNumber);
            if (!isNaN(targetNumber)) {
              const userZahl = Math.floor(Math.random() * targetNumber + 1);
              sendMessage(`${userName} deine Zahl lautet ${userZahl}`);
            } else {
              sendMessage(`${userName} du musst eine Zahl angeben!`);
            }
          }

          //const messages = data.payload.event.message.text;
          //console.log(data.payload.event.message.text);
          //textBoxMessages.innerHTML += `<br>${messages}`;
        }
        if (data.metadata.message_type === "session_welcome") {
          registerEventSub(data.payload.session.id);
        }
      }
      async function registerEventSub(sessionId) {
        const responseStart = await fetch(
          "https://api.twitch.tv/helix/eventsub/subscriptions",
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Client-Id": CLIENT_ID,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              type: "channel.chat.message",
              version: "1",
              condition: {
                broadcaster_user_id: userId,
                user_id: userId,
              },
              transport: {
                method: "websocket",
                session_id: sessionId,
              },
            }),
          }
        );
        if (responseStart.ok) {
          chatBox.hidden = false;
        }
      }
      async function removeDisconnectedWebsocketSubscriptions() {
        const response = await fetch(
          "https://api.twitch.tv/helix/eventsub/subscriptions",
          {
            headers: {
              Authorization: `Bearer ${token}`,
              "Client-Id": CLIENT_ID,
            },
          }
        );

        if (response.ok) {
          const { data } = await response.json();
          await Promise.all(
            data.map(({ id, status }) => {
              if (status === "websocket_disconnected") {
                return fetch(
                  `https://api.twitch.tv/helix/eventsub/subscriptions?id=${id}`,
                  {
                    method: "DELETE",
                    headers: {
                      Authorization: `Bearer ${token}`,
                      "Client-Id": CLIENT_ID,
                    },
                  }
                );
              }
            })
          );
        }
      }

      function sendMessage(message) {
        return fetch("https://api.twitch.tv/helix/chat/messages", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Client-Id": CLIENT_ID,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            broadcaster_id: userId,
            sender_id: userId,
            message: message,
          }),
        });
      }
      function sendText(event) {
        event.preventDefault();
        const sendValue = sendBox.value;
        console.log(`TEXT: ${sendValue}`);
        sendMessage(sendValue);
        sendBox.value = "";
      }
    </script>
  </body>
</html>
